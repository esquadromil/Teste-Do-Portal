<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Portal Esquadromil</title>
<style>
:root{
  --azul:#1B2F91;
  --vermelho:#FF2B2B;
  --branco:#FFFFFF;
  --card: rgba(255,255,255,0.06);
  --max-width:1100px;
  /* Troca aqui para usar a fachada: ex: url('fachada.jpg') */
  --fachada: url('fachada.jpg');
}

/* reset */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:"Segoe UI",Arial,sans-serif;
  color:var(--branco);
  background-image: linear-gradient(180deg, rgba(11,22,90,0.55), rgba(6,9,34,0.82)), var(--fachada);
  background-blend-mode: overlay;
  background-size: cover;
  background-position: center top;
  -webkit-font-smoothing:antialiased;
  overflow-x:hidden;
  padding-top:86px;
}

/* subtle vignette */
body::after{content:"";position:fixed;inset:0;pointer-events:none;
  background: radial-gradient(ellipse at center, rgba(0,0,0,0.0) 0%, rgba(0,0,0,0.28) 65%, rgba(0,0,0,0.55) 100%);
  z-index:0}

/* intro */
#intro{position:fixed;top:0;left:0;width:100%;height:100vh;
  background: radial-gradient(circle, rgba(27,47,145,0.98), rgba(6,9,34,0.95));
  display:flex;justify-content:center;align-items:center;flex-direction:column;
  z-index:50;animation:fadeOutIntro 1s ease 3.5s forwards}
#intro img{width:200px;animation:logoGrow 3s ease forwards}

/* header */
header{
  position:fixed;top:0;left:0;width:100%;height:76px;
  display:flex;align-items:center;justify-content:center;
  background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
  backdrop-filter: blur(6px);z-index:45;padding:8px 16px;box-shadow:0 6px 18px rgba(0,0,0,0.18)
}
header img{height:56px;transition:transform .25s}
header img:hover{transform:scale(1.03)}

/* wrapper + card */
.wrapper{display:flex;justify-content:center;align-items:flex-start;width:100%;padding:28px 18px 80px 18px;z-index:10}
.card{
  width:100%;max-width:var(--max-width);border-radius:18px;
  background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
  box-shadow: 0 20px 60px rgba(4,9,30,0.6); padding:28px;margin:8px;color:var(--branco);z-index:12;overflow:hidden;
  border:1px solid rgba(255,255,255,0.04)
}

/* header row inside card */
.header-row{display:flex;align-items:center;gap:18px;margin-bottom:12px}
.header-row img.logo{width:72px;height:72px;object-fit:contain;border-radius:10px;background:rgba(255,255,255,0.04);padding:8px}
.title-block{flex:1;text-align:left}
.title-block h1{font-size:1.6rem;margin-bottom:4px}
.title-block p{margin:0;color:rgba(255,255,255,0.9);font-size:0.95rem}

/* sections grid */
.sections{display:grid;grid-template-columns:1fr 380px;gap:18px;margin-top:10px;align-items:start}
.left-column{display:flex;flex-direction:column;gap:18px}
.right-column{display:flex;flex-direction:column;gap:18px}
.section{background:var(--card);border-radius:12px;padding:18px;min-width:0;border:1px solid rgba(255,255,255,0.03)}
.section h2{font-size:1.05rem;margin:0 0 12px 0;display:flex;align-items:center;gap:10px;color:var(--branco)}
.section .desc{color:rgba(255,255,255,0.85);font-size:0.92rem;margin-bottom:12px}

/* buttons */
.btn-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.app-btn{background:var(--branco);color:var(--azul);border:none;border-radius:10px;padding:12px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:space-between;gap:10px;box-shadow:0 12px 30px rgba(3,9,40,0.25);transition:transform .18s,background .18s,color .18s}
.app-btn .emoji{margin-right:8px;font-size:1.05rem}
.app-btn .tag{background:var(--azul);color:var(--branco);padding:6px 10px;border-radius:8px;font-size:.75rem;font-weight:700}
.app-btn:hover{transform:translateY(-4px);background:var(--vermelho);color:var(--branco)}
.app-btn:hover .tag{background:rgba(255,255,255,0.15);color:var(--branco)}

/* footer */
.card-footer{margin-top:18px;text-align:center;color:rgba(255,255,255,0.75);font-size:0.9rem}

/* form overlays */
.form-container{display:none;position:fixed;inset:0;z-index:60;background:linear-gradient(180deg, rgba(6,9,34,0.6), rgba(6,9,34,0.88));padding:24px;overflow:auto;align-items:center;justify-content:center}
.panel{width:100%;max-width:920px;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));border-radius:12px;padding:20px;margin:12px auto;color:var(--branco);box-shadow:0 18px 50px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.04)}

/* forms */
.form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;align-items:start}
.form-grid .full{grid-column:1/-1}
.form-grid label{display:block;margin-bottom:6px;font-size:.88rem;color:rgba(255,255,255,0.92)}
.form-grid input[type="text"],.form-grid input[type="date"],.form-grid input[type="time"],.form-grid input[type="password"],.form-grid select,.form-grid textarea{width:100%;padding:10px 12px;border-radius:8px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);color:var(--branco);font-size:.95rem}
.form-grid textarea{min-height:88px;resize:vertical}

/* buttons styles */
button[type="submit"],#btnMakePDF,#btnGenQR,#btnDownloadQR,.voltar-btn,#btnValidarSenha{background:linear-gradient(90deg,var(--azul),#122069);color:var(--branco);border:none;padding:10px 14px;border-radius:10px;font-weight:700;transition:transform .14s,opacity .12s;box-shadow:0 10px 26px rgba(18,32,102,0.3)}
button[type="submit"]:hover,.voltar-btn:hover,#btnMakePDF:hover{transform:translateY(-3px);opacity:.95}

/* small utils */
.hidden{display:none!important}
.center{text-align:center}
.panel h2{margin-bottom:8px}

/* scanner */
#video{width:100%;max-height:420px;border-radius:10px;background:rgba(0,0,0,0.45);object-fit:cover}
.scanner-buttons{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
#history{margin-top:10px;list-style:none;max-height:160px;overflow:auto;padding:6px;border-radius:8px;background:rgba(0,0,0,0.25)}
#history li{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:.95rem}

/* qr preview */
.qr-preview{display:flex;justify-content:center;align-items:center;gap:12px}
.qr-card{background:rgba(255,255,255,0.02);padding:12px;border-radius:8px;display:flex;flex-direction:column;align-items:center}

/* thumbs */
.thumbs{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
.thumb{position:relative;width:120px;height:90px;border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.04);background:rgba(0,0,0,0.2);display:flex;align-items:center;justify-content:center}
.thumb img{width:100%;height:100%;object-fit:cover}
.thumb .remove{position:absolute;top:6px;right:6px;background:rgba(0,0,0,0.45);padding:4px 7px;border-radius:6px;cursor:pointer;font-weight:700}

/* responsive */
@media(max-width:1100px){:root{--max-width:980px}.sections{grid-template-columns:1fr 320px}}
@media(max-width:900px){body{padding-top:86px}.sections{grid-template-columns:1fr}.right-column{order:2}.btn-grid{grid-template-columns:1fr 1fr}.card{padding:18px}.form-grid{grid-template-columns:1fr}}
@media(max-width:560px){header img{height:44px}.header-row img.logo{width:56px;height:56px}.title-block h1{font-size:1.2rem;text-align:center}.header-row{gap:12px;align-items:center}.btn-grid{grid-template-columns:1fr}.panel{padding:14px;margin:8px}.thumb{width:96px;height:72px}}

/* animations */
@keyframes logoGrow{0%{transform:scale(.5);opacity:0}50%{transform:scale(.8);opacity:.7}100%{transform:scale(1);opacity:1}}
@keyframes fadeOutIntro{to{opacity:0;visibility:hidden}}

/* placeholders */
input::placeholder,textarea::placeholder{color:rgba(255,255,255,0.5)}
</style>
</head>
<body>

<!-- Intro & Header -->
<div id="intro"><img src="logobranca.png" alt="Logo Esquadromil"></div>
<header><img src="logocolorida.png" alt="Logo Esquadromil"></header>

<!-- Main Card -->
<div class="wrapper">
  <div class="card">
    <div class="header-row">
      <img class="logo" src="logobranca.png" alt="Esquadromil">
      <div class="title-block">
        <h1>Portal Esquadromil</h1>
        <p class="slogan">Sistema de suporte e comunica√ß√£o ‚Äî tecnologia que conecta</p>
      </div>
    </div>

    <div class="sections">
      <!-- LEFT -->
      <div class="left-column">
        <div class="section" id="sistemasSection">
          <h2>üîß Sistemas</h2>
          <div class="desc">Formul√°rios e controle operacional.</div>
          <div class="btn-grid">
            <button class="app-btn" id="btnChamado"><span class="emoji">üíª</span><span style="flex:1;text-align:left">Chamado TI</span><div class="tag">Chamado</div></button>
            <button class="app-btn" id="btnGuarita"><span class="emoji">üõ°Ô∏è</span><span style="flex:1;text-align:left">Agendamento Guarita</span><div class="tag">Guarita</div></button>
            <button class="app-btn" id="btnScanner" style="grid-column:1/-1"><span class="emoji">üì∑</span><span style="flex:1;text-align:left">Scanner QR (bloqueado por senha)</span><div class="tag">Scanner</div></button>
          </div>
        </div>

        <div class="section" id="aplicacoesSection">
          <h2>üß© Aplica√ß√µes</h2>
          <div class="desc">Ferramentas utilit√°rias.</div>
          <div class="btn-grid">
            <button class="app-btn" id="btnQRGen"><span class="emoji">üîñ</span><span style="flex:1;text-align:left">Gerador QR</span><div class="tag">QR</div></button>
            <button class="app-btn" id="btnPDF" style="grid-column:1/-1"><span class="emoji">üìÑ</span><span style="flex:1;text-align:left">Digitalizar ‚Üí PDF</span><div class="tag">PDF</div></button>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="right-column">
        <!-- Removed "Atalhos R√°pidos" as requested -->
        <div class="section">
          <h2>üóì Pr√≥ximos Agendamentos</h2>
          <div class="desc">Vis√£o r√°pida dos pr√≥ximos eventos na guarita.</div>
          <div style="min-height:80px;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.82)">Nenhum agendamento para hoje.</div>
        </div>

        <div class="section">
          <h2>üìé Recursos</h2>
          <div class="desc">Links √∫teis (opcional).</div>
          <ul style="list-style:none;padding-left:0;margin:0;color:rgba(255,255,255,0.9)">
            <li style="padding:6px 0">üìÅ Manual interno</li>
            <li style="padding:6px 0">üîê Pol√≠ticas</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="card-footer">¬© 2025 Esquadromil ‚Äî Mantido o funcionamento original dos sistemas.</div>
  </div>
</div>

<!-- === FORMS & MODALS (integrations preserved) === -->

<!-- CHAMADO TI -->
<div id="formChamado" class="form-container">
  <div class="panel">
    <form id="form">
      <h2>TI - Abertura de Chamados</h2>
      <div class="form-grid">
        <div><label for="nome">Nome:</label><input type="text" name="nome" id="nome" required/></div>
        <div>
          <label for="setor">Setor:</label>
          <select name="setor" id="setor" required>
            <option value="">Selecione</option><option>TI</option><option>Produ√ß√£o</option><option>Financeiro</option>
            <option>Processos</option><option>Compras</option><option>RH</option><option>DP</option>
            <option>Contabilidade</option><option>Comercial</option><option>Televendas</option><option>Log√≠stica</option>
            <option>Marketing</option><option>Diretoria</option>
          </select>
        </div>

        <div class="full">
          <label for="problema">Tipo de Problema:</label>
          <select name="problema" id="problema" required>
            <option value="">Selecione</option>
            <option>Falha de impress√£o</option><option>Impressora travada</option><option>Abertura de tabela de pre√ßo</option>
            <option>Precifica√ß√£o de produtos</option><option>Computador travando/lento</option><option>Problemas de rede</option>
            <option>Sistema indispon√≠vel</option><option>Cadastro RCA</option><option>Erro Transmiss√£o NFE</option>
            <option>Troca Toner Impressora</option><option>Solicitar Perif√©ricos (fones,mouse)</option><option>Outros</option>
          </select>
        </div>

        <div id="outro-problema" class="hidden full">
          <label for="outro">Descreva o problema:</label><textarea name="outro" id="outro" rows="4"></textarea>
        </div>

        <div>
          <label for="urgencia">Urg√™ncia:</label>
          <select name="urgencia" id="urgencia" required>
            <option value="">Selecione</option><option>Baixa</option><option>M√©dia</option><option>Alta</option>
          </select>
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;">
        <button type="submit">Enviar Chamado</button>
        <button type="button" class="voltar-btn" onclick="voltarMenu()">‚¨Ö Voltar</button>
      </div>
      <div id="mensagem" style="margin-top:10px;font-weight:700;"></div>
    </form>
  </div>
</div>

<!-- GUARITA -->
<div id="formGuarita" class="form-container">
  <div class="panel">
    <form id="formGuaritaForm">
      <h2>Agendamento Guarita</h2>
      <div class="form-grid">
        <div><label for="nomeG">Nome:</label><input type="text" name="nomeG" id="nomeG" required/></div>
        <div><label for="setorG">Setor:</label><input type="text" name="setorG" id="setorG" required/></div>
        <div><label for="visitante">Visitante:</label><input type="text" name="visitante" id="visitante" required/></div>
        <div><label for="motivo">Motivo:</label><input type="text" name="motivo" id="motivo" required/></div>
        <div><label for="data">Data:</label><input type="date" name="data" id="data" required/></div>
        <div><label for="hora">Hora:</label><input type="time" name="hora" id="hora" required/></div>
        <div class="full"><label for="obs">Observa√ß√µes:</label><textarea name="obs" id="obs" rows="3"></textarea></div>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;">
        <button type="submit">Enviar Agendamento</button>
        <button type="button" class="voltar-btn" onclick="voltarMenu()">‚¨Ö Voltar</button>
      </div>
      <div id="mensagemGuarita" style="margin-top:10px;font-weight:700;"></div>
    </form>
  </div>
</div>

<!-- SENHA -->
<div id="senhaContainer" class="form-container">
  <div class="panel center">
    <h2>üîí Acesso Restrito</h2>
    <p>Digite a senha para acessar o Scanner:</p>
    <input type="password" id="senhaInput" placeholder="Senha" />
    <div style="margin-top:10px;">
      <button id="btnValidarSenha">Acessar</button>
    </div>
    <div id="senhaMsg" style="margin-top:12px;"></div>
    <div style="margin-top:16px;"><button class="voltar-btn" onclick="voltarMenu()">‚¨Ö Voltar</button></div>
  </div>
</div>

<!-- SCANNER -->
<div id="scannerContainer" class="form-container">
  <div class="panel">
    <h2>üì∑ Scanner de QR Codes</h2>
    <video id="video" playsinline></video>
    <div class="scanner-buttons">
      <button id="startBtn">Iniciar C√¢mera</button>
      <button id="stopBtn">Parar C√¢mera</button>
      <button id="exportBtn">Exportar Excel</button>
      <button id="clearBtn">Limpar Hist√≥rico</button>
    </div>
    <ul id="history"></ul>
    <div style="margin-top:12px;text-align:center;"><button class="voltar-btn" onclick="voltarMenu()">‚¨Ö Voltar</button></div>
  </div>
</div>

<!-- QR GENERATOR -->
<div id="qrGenerator" class="form-container">
  <div class="panel">
    <h2>üîñ Gerador de QR Code</h2>
    <div class="form-grid">
      <div class="full">
        <label for="qrText">Texto ou URL:</label>
        <input type="text" id="qrText" placeholder="Cole o link ou texto aqui (ex: https://...)" />
      </div>
      <div>
        <label for="qrSize">Tamanho (px):</label>
        <select id="qrSize">
          <option value="180">180</option><option value="240" selected>240</option><option value="360">360</option><option value="480">480</option>
        </select>
      </div>
      <div>
        <label for="qrLogo">Incluir logo central:</label>
        <select id="qrLogo">
          <option value="none" selected>N√£o</option>
          <option value="small">Pequeno</option>
        </select>
      </div>

      <div class="full center" style="margin-top:8px;">
        <div class="qr-preview">
          <div class="qr-card">
            <div id="qrcode"></div>
            <div style="font-size:12px;color:rgba(255,255,255,0.8)">Preview</div>
          </div>
        </div>

        <div class="qr-controls" style="margin-top:8px;">
          <button id="btnGenQR">Gerar QR</button>
          <button id="btnDownloadQR" class="secondary">Baixar PNG</button>
          <button class="voltar-btn" onclick="voltarMenu()">‚¨Ö Voltar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- IMAGE -> PDF -->
<div id="pdfScanner" class="form-container">
  <div class="panel">
    <h2>üìÑ Digitalizar Imagens ‚Üí PDF</h2>
    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
      <div>
        <label for="fileInput">Escolher imagens (v√°rias):</label>
        <input type="file" id="fileInput" accept="image/*" multiple />
      </div>
      <div>
        <label for="cameraCapture">Ou tirar foto (mobile):</label>
        <input type="file" id="cameraCapture" accept="image/*" capture="environment" />
      </div>
      <div style="min-width:220px;">
        <label for="pdfName">Nome do arquivo PDF:</label>
        <input type="text" id="pdfName" placeholder="ex: Contrato_123" />
      </div>
    </div>

    <div class="thumbs" id="thumbs"></div>

    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;">
      <button id="btnMakePDF">Gerar PDF</button>
      <button id="btnClearThumbs" class="secondary">Limpar imagens</button>
      <button class="voltar-btn" onclick="voltarMenu()">‚¨Ö Voltar</button>
    </div>
    <div id="pdfMsg" style="margin-top:10px;font-weight:700"></div>
  </div>
</div>

<!-- External libs kept -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.18.6/umd/index.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- MAIN SCRIPT: integra√ß√µes preservadas e adaptadas ao novo layout -->
<script>
/* -------------------------
   Navega√ß√£o entre pain√©is
   ------------------------- */
const formChamado = document.getElementById('formChamado');
const formGuarita = document.getElementById('formGuarita');
const senhaContainer = document.getElementById('senhaContainer');
const scannerContainer = document.getElementById('scannerContainer');
const qrGenerator = document.getElementById('qrGenerator');
const pdfScanner = document.getElementById('pdfScanner');

document.getElementById('btnChamado').onclick = ()=>{ hideAll(); formChamado.style.display='flex'; }
document.getElementById('btnGuarita').onclick = ()=>{ hideAll(); formGuarita.style.display='flex'; }
document.getElementById('btnScanner').onclick = ()=>{ hideAll(); senhaContainer.style.display='flex'; }
document.getElementById('btnQRGen').onclick = ()=>{ hideAll(); qrGenerator.style.display='flex'; renderEmptyQR(); }
document.getElementById('btnPDF').onclick = ()=>{ hideAll(); pdfScanner.style.display='flex'; }

function hideAll(){
  [formChamado,formGuarita,senhaContainer,scannerContainer,qrGenerator,pdfScanner].forEach(el=>el.style.display='none');
}
function voltarMenu(){
  [formChamado,formGuarita,senhaContainer,scannerContainer,qrGenerator,pdfScanner].forEach(el=>el.style.display='none');
  window.scrollTo({top:0,behavior:'smooth'});
}

/* -------------------------
   Senha (Scanner)
   ------------------------- */
const senhaInput = document.getElementById('senhaInput');
const senhaMsg = document.getElementById('senhaMsg');
document.getElementById('btnValidarSenha').onclick = ()=>{
  if(senhaInput.value === "TIESQUADROMIL"){
    senhaMsg.style.color="#00ff88"; senhaMsg.textContent="‚úÖ Acesso liberado!";
    setTimeout(()=>{ senhaContainer.style.display='none'; scannerContainer.style.display='flex'; senhaInput.value=''; senhaMsg.textContent=''; window.scrollTo({top:0,behavior:'smooth'}); }, 450);
  } else {
    senhaMsg.style.color="#ff6666"; senhaMsg.textContent="‚ùå Senha incorreta!";
  }
};

/* -------------------------
   Chamado & Guarita
   ------------------------- */
/* Apps Script endpoints (mantidos conforme teu c√≥digo original) */
const scriptChamado = 'https://script.google.com/macros/s/AKfycbw8bt5spo8b1Ve77XhYHC0N9jiMH6c-je-84C1zvsld1gHCcpUxAm-K9I1ySlW4huiJ/exec';
const scriptGuarita = 'https://script.google.com/macros/s/AKfycbwsLgZxTwI4jod2SlL6IU1xZmYYj5hWy0-X_1Wki9GeNGlW40x8Bv5bbADRkjOiqHaM/exec';

const form = document.getElementById('form');
const outroInput = document.getElementById('outro-problema');
const problemaSelect = document.getElementById('problema');
const mensagem = document.getElementById('mensagem');

const tempos = {"Falha de impress√£o":"10 minutos","Impressora travada":"10 minutos","Abertura de tabela de pre√ßo":"10 minutos","Precifica√ß√£o de produtos":"20 minutos","Computador travando/lento":"20 minutos","Problemas de rede":"20 minutos","Sistema indispon√≠vel":"30 minutos","Cadastro RCA":"20 minutos","Erro Transmiss√£o NFE":"30 minutos","Troca Toner Impressora":"15 minutos","Solicitar Perif√©ricos (fones,mouse)":"15 minutos","Outros":"15 minutos"};

problemaSelect.addEventListener('change', ()=>{ outroInput.classList.toggle('hidden', problemaSelect.value !== 'Outros'); });

form.addEventListener('submit', e=>{
  e.preventDefault();
  const data = new FormData(form);
  const tempo = tempos[problemaSelect.value]||"15 minutos";
  mensagem.textContent="‚è≥ Enviando chamado..."; mensagem.style.color="#ffd700"; mensagem.style.opacity=1;
  fetch(scriptChamado, { method:'POST', body:new URLSearchParams(data) })
    .then(r=>r.json()).then(result=>{
      if(result.result==="success"){ mensagem.innerHTML=`‚úÖ Chamado enviado com sucesso!<br>‚è≥ Em at√© <b>${tempo}</b> nossa equipe entrar√° em contato.`; mensagem.style.color="#00ff88"; }
      else { mensagem.textContent="‚ùå Erro ao enviar."; mensagem.style.color="#ff4444"; }
    }).catch(()=>{ mensagem.textContent="‚ùå Erro na conex√£o."; mensagem.style.color="#ff4444"; })
    .finally(()=>{ form.reset(); outroInput.classList.add("hidden"); setTimeout(()=>mensagem.style.opacity=0,5000); });
});

const formG = document.getElementById('formGuaritaForm');
const mensagemG = document.getElementById('mensagemGuarita');

formG.addEventListener('submit', e=>{
  e.preventDefault();
  const data = new FormData(formG);
  mensagemG.textContent = "‚è≥ Enviando agendamento..."; mensagemG.style.color="#ffd700";
  fetch(scriptGuarita, { method:'POST', body:new URLSearchParams(data) })
    .then(r=>r.json()).then(result=>{
      if(result.result==="success"){ mensagemG.textContent="‚úÖ Agendamento enviado com sucesso!"; mensagemG.style.color="#00ff88"; }
      else{ mensagemG.textContent="‚ùå Erro ao enviar."; mensagemG.style.color="#ff4444"; }
    }).catch(()=>{ mensagemG.textContent="‚ùå Erro na conex√£o."; mensagemG.style.color="#ff4444"; })
    .finally(()=>{ formG.reset(); setTimeout(()=>mensagemG.style.opacity=0,5000); });
});

/* -------------------------
   SCANNER (ZXing)
   ------------------------- */
const video = document.getElementById('video');
const historyList = document.getElementById('history');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const exportBtn = document.getElementById('exportBtn');
const clearBtn = document.getElementById('clearBtn');

const codeReader = new ZXing.BrowserQRCodeReader();
let currentStream = null;
let scannedData = JSON.parse(localStorage.getItem('scannedCodes') || '[]');

function updateHistoryList(){
  historyList.innerHTML = '';
  scannedData.slice().reverse().forEach(item=>{
    const li = document.createElement('li');
    li.innerHTML = `<span style="font-weight:700">${item}</span>`;
    historyList.appendChild(li);
  });
  localStorage.setItem('scannedCodes', JSON.stringify(scannedData));
}
updateHistoryList();

startBtn.onclick = async ()=>{
  try{
    const devices = await codeReader.listVideoInputDevices();
    let deviceId = devices.length ? devices[0].deviceId : null;
    for(const d of devices){ if(d.label && /back|rear|environment|traseira/i.test(d.label)){ deviceId = d.deviceId; break; } }
    currentStream = await navigator.mediaDevices.getUserMedia({ video: deviceId ? { deviceId } : { facingMode: "environment" } });
    video.srcObject = currentStream; video.play();
    codeReader.decodeFromVideoDevice(deviceId, video, (result, err) => {
      if(result){
        const text = result.text;
        if(!scannedData.includes(text)){
          scannedData.push(text);
          updateHistoryList();
          try{ navigator.vibrate && navigator.vibrate(200); }catch(e){}
        }
      }
    });
  }catch(e){ alert("Erro ao acessar c√¢mera: " + (e && e.message ? e.message : e)); }
};
stopBtn.onclick = ()=>{
  if(currentStream){ currentStream.getTracks().forEach(t=>t.stop()); currentStream=null; }
  try{ codeReader.reset(); }catch(e){}
  video.srcObject = null;
};
clearBtn.onclick = ()=>{ if(confirm('Limpar hist√≥rico de scans?')){ scannedData = []; updateHistoryList(); } };
exportBtn.onclick = ()=>{
  if(scannedData.length===0){ alert('Nenhum QR Code escaneado!'); return; }
  const ws_data = [['QR Code']].concat(scannedData.map(x=>[x]));
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Scans');
  XLSX.writeFile(wb, 'scanned_codes.xlsx');
};

/* -------------------------
   QR GENERATOR (QRCode.js)
   ------------------------- */
let qrInstance = null;
function renderEmptyQR(){
  const qdiv = document.getElementById('qrcode');
  if(!qdiv) return;
  qdiv.innerHTML = '';
  qrInstance = new QRCode(qdiv, { text: "https://esquadromil.com", width:240, height:240, colorDark:"#000000", colorLight:"#ffffff", correctLevel: QRCode.CorrectLevel.H });
}
renderEmptyQR();

document.getElementById('btnGenQR').onclick = ()=>{
  const text = document.getElementById('qrText').value.trim();
  const size = parseInt(document.getElementById('qrSize').value || 240);
  const logoOpt = document.getElementById('qrLogo').value;
  const qdiv = document.getElementById('qrcode');
  qdiv.innerHTML = '';
  qrInstance = new QRCode(qdiv, { text: text || " ", width: size, height: size, colorDark: "#000000", colorLight:"#ffffff", correctLevel: QRCode.CorrectLevel.H });
  if(logoOpt !== 'none'){
    const img = document.createElement('img');
    img.src = 'logobranca.png';
    img.style.width = (size * 0.18) + 'px';
    img.style.height = 'auto';
    img.style.marginTop = '-' + (size * 0.18) + 'px';
    img.style.pointerEvents = 'none';
    img.style.background = 'transparent';
    img.style.borderRadius = '6px';
    setTimeout(()=>{ qdiv.appendChild(img); }, 220);
  }
};

document.getElementById('btnDownloadQR').onclick = ()=>{
  const qdiv = document.getElementById('qrcode').querySelector('img') || document.getElementById('qrcode').querySelector('canvas');
  if(!qdiv){ alert('Gere o QR primeiro.'); return; }
  let dataUrl = '';
  if(qdiv.tagName.toLowerCase() === 'img') dataUrl = qdiv.src;
  else { dataUrl = qdiv.toDataURL('image/png'); }
  const a = document.createElement('a');
  a.href = dataUrl;
  a.download = (document.getElementById('qrText').value || 'qrcode').replace(/\s+/g,'_') + '.png';
  document.body.appendChild(a); a.click(); a.remove();
};

/* -------------------------
   IMAGE -> PDF (jsPDF)
   ------------------------- */
const fileInput = document.getElementById('fileInput');
const cameraCapture = document.getElementById('cameraCapture');
const thumbs = document.getElementById('thumbs');
const btnMakePDF = document.getElementById('btnMakePDF');
const btnClearThumbs = document.getElementById('btnClearThumbs');
const pdfName = document.getElementById('pdfName');
const pdfMsg = document.getElementById('pdfMsg');

let imagesForPdf = [];

function addImageFile(file){
  const reader = new FileReader();
  reader.onload = (e)=>{
    const dataURL = e.target.result;
    const div = document.createElement('div'); div.className='thumb';
    const img = document.createElement('img'); img.src = dataURL;
    const rem = document.createElement('div'); rem.className='remove'; rem.textContent='‚úï';
    rem.onclick = ()=>{ thumbs.removeChild(div); imagesForPdf = imagesForPdf.filter(it=>it.dataURL !== dataURL); updatePdfMsg(); };
    div.appendChild(img); div.appendChild(rem);
    thumbs.appendChild(div);
    imagesForPdf.push({file,dataURL});
    updatePdfMsg();
  };
  reader.readAsDataURL(file);
}

fileInput.addEventListener('change',(e)=>{Array.from(e.target.files||[]).forEach(f=>addImageFile(f));fileInput.value='';});
cameraCapture.addEventListener('change',(e)=>{Array.from(e.target.files||[]).forEach(f=>addImageFile(f));cameraCapture.value='';});

btnClearThumbs.onclick = ()=>{ if(confirm('Remover todas as imagens?')){ imagesForPdf=[]; thumbs.innerHTML=''; updatePdfMsg(); } };

function updatePdfMsg(){ pdfMsg.textContent = imagesForPdf.length ? `${imagesForPdf.length} imagem(ns) prontas.` : 'Nenhuma imagem selecionada.'; }

btnMakePDF.onclick = async ()=>{
  if(imagesForPdf.length===0){ alert('Selecione ao menos uma imagem.'); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'px', format:'a4' });
  const pageW = doc.internal.pageSize.getWidth();
  const pageH = doc.internal.pageSize.getHeight();

  pdfMsg.textContent = '‚è≥ Gerando PDF...';
  for(let i=0;i<imagesForPdf.length;i++){
    const it = imagesForPdf[i];
    await new Promise((res,rej)=>{
      const img = new Image();
      img.onload = ()=>{
        const margin = 20;
        let iw = img.width, ih = img.height;
        const ratio = Math.min((pageW - margin*2)/iw, (pageH - margin*2)/ih, 1);
        const dw = iw * ratio, dh = ih * ratio;
        const x = (pageW - dw)/2, y = (pageH - dh)/2;
        doc.addImage(img,'JPEG',x,y,dw,dh);
        if(i < imagesForPdf.length -1) doc.addPage();
        res();
      };
      img.onerror = ()=>{ console.error('img load err'); res(); };
      img.src = it.dataURL;
    });
  }
  const filename = (pdfName.value.trim() || 'documento').replace(/[^\w\-_.]/g,'_') + '.pdf';
  doc.save(filename);
  pdfMsg.textContent = '‚úÖ PDF gerado e baixado: ' + filename;
};

/* init */
updatePdfMsg();
renderEmptyQR();
</script>
</body>
</html>
